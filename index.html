<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Author Information -->
        <div class="text-right mb-2">
            <!-- <p class="text-xs text-gray-500">Author: MOHD AHSHAN DANIHS</p> -->
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Inventory Manager</h1>

            <!-- Input Section -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OFS URL</label>
                    <input type="text" id="ofsUrl" placeholder="Enter OFS URL" value="https://sunrise0542.fs.ocs.oraclecloud.com/" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Resource ID</label>
                    <input type="text" id="resourceId" placeholder="Enter Resource ID" value="ROYS" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OFSC User ID</label>
                    <input type="text" id="ofscUserId" value="ineventorymanager@dsunrise0542" placeholder="Enter OFSC User ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OFSC Password</label>
                    <input type="password" id="ofscPassword" value="d598de5d0034a055014bff172d45d7f0acb7b3ba14d8ede7301a76e8cb31" placeholder="Enter OFSC Password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
            </div>
            <div class="flex justify-end mb-6">
                <button onclick="fetchInventories()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Fetch Inventories
                </button>
            </div>

            <!-- Status Message -->
            <div id="statusMessage" class="hidden mb-4 p-4 rounded-lg"></div>
        </div>

        <!-- Resource Details Card -->
        <div id="resourceDetailsCard" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Resource Details</h2>
                <button onclick="closeResourceDetails()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="resourceDetailsContent" class="grid grid-cols-2 gap-4">
                <!-- Dynamic resource details will be loaded here -->
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Inventory Items</h2>
                    <p class="text-gray-600" id="resultCount">Total Results: 0</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadBackup()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        üì• Download Backup
                    </button>
                    <button onclick="fetchResourceDetails()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Resource Detail
                    </button>
                    <button onclick="selectAll()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        Select All
                    </button>
                    <button onclick="deselectAll()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        Deselect All
                    </button>
                    <button onclick="updateSelected()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Update Selected
                    </button>
                    <button onclick="deleteSelected()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Delete Selected
                    </button>
                </div>
            </div>

            <!-- Pagination Controls -->
            <div class="flex justify-between items-center mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-4">
                    <label class="text-sm font-medium text-gray-700">Items per page:</label>
                    <select id="limitSelect" onchange="changeLimit()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="firstPage()" id="firstBtn" class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚èÆÔ∏è First
                    </button>
                    <button onclick="previousPage()" id="prevBtn" class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚¨ÖÔ∏è Previous
                    </button>
                    <span class="px-4 py-2 text-sm font-medium text-gray-700" id="pageInfo">Page 1</span>
                    <button onclick="nextPage()" id="nextBtn" class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Next ‚û°Ô∏è
                    </button>
                    <button onclick="lastPage()" id="lastBtn" class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Last ‚è≠Ô∏è
                    </button>
                </div>
                <div class="text-sm text-gray-600" id="rangeInfo">
                    Showing 0-0 of 0
                </div>
            </div>

            <div class="overflow-x-auto">
                <div class="mb-4">
                    <input type="text" id="searchInput" placeholder="Search inventory..." class="w-full px-3 py-2 border rounded-lg " />
                </div>
                <table class="w-full">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                        <tr id="tableHeader">
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            <!-- Dynamic headers will be generated here -->
                        </tr>
                    </thead>
                    <tbody id="inventoryTable" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div id="updateModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-8 border w-full max-w-3xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Update Inventory</h3>
                <button onclick="closeUpdateModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>

            <form id="updateForm" class="space-y-4">
                <div id="dynamicFormFields" class="grid grid-cols-2 gap-4">
                    <!-- Dynamic fields will be generated here -->
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeUpdateModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let inventoryData = [];
        let allInventoryData = []; // Store all fetched data for backup
        let selectedItems = new Set();
        let currentEditItem = null;
        let currentPage = 1;
        let itemsPerPage = 100;
        let totalResults = 0;
        let tableColumns = []; // Store dynamic columns
        let primaryDisplayColumns = ['inventoryId', 'status', 'quantity', 'Category', 'inventoryType']; // Default columns to show

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `mb-4 p-4 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            statusDiv.classList.remove('hidden');
            setTimeout(() => statusDiv.classList.add('hidden'), 8000);
        }

        async function fetchResourceDetails() {
            const ofsUrl = document.getElementById('ofsUrl').value.trim();
            const resourceId = document.getElementById('resourceId').value.trim();
            const userId = document.getElementById('ofscUserId').value.trim();
            const password = document.getElementById('ofscPassword').value.trim();

            if (!ofsUrl || !resourceId || !userId || !password) {
                showStatus('Please enter OFS URL, Resource ID, User ID, and Password', true);
                return;
            }

            const apiUrl = `${ofsUrl}/rest/ofscCore/v1/resources/${resourceId}`;
            const authString = btoa(`${userId}:${password}`);

            try {
                showStatus('Fetching resource details...');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Basic ${authString}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const resourceData = await response.json();
                displayResourceDetails(resourceData);
                showStatus('Resource details loaded successfully');
            } catch (error) {
                showStatus(`Error fetching resource details: ${error.message}`, true);
                console.error('Error:', error);
            }
        }

        function displayResourceDetails(data) {
            const card = document.getElementById('resourceDetailsCard');
            const content = document.getElementById('resourceDetailsContent');

            content.innerHTML = '';

            // Display all resource properties
            Object.keys(data).forEach(key => {
                const label = key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');

                let value = data[key];

                // Handle null/undefined values
                if (value === null || value === undefined) {
                    value = 'N/A';
                } else if (typeof value === 'object') {
                    // Handle nested objects/arrays
                    value = JSON.stringify(value, null, 2);
                } else if (typeof value === 'boolean') {
                    value = value ? 'Yes' : 'No';
                }

                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'border-b border-gray-200 pb-2';
                fieldDiv.innerHTML = `
                    <div class="text-sm font-medium text-gray-500 mb-1">${label}</div>
                    <div class="text-base text-gray-900 ${typeof data[key] === 'object' ? 'font-mono text-xs whitespace-pre-wrap' : ''}">${value}</div>
                `;
                content.appendChild(fieldDiv);
            });

            card.classList.remove('hidden');
        }

        function closeResourceDetails() {
            document.getElementById('resourceDetailsCard').classList.add('hidden');
        }

        async function fetchInventories(offset = 0) {
            const ofsUrl = document.getElementById('ofsUrl').value.trim();
            const resourceId = document.getElementById('resourceId').value.trim();
            const userId = document.getElementById('ofscUserId').value.trim();
            const password = document.getElementById('ofscPassword').value.trim();

            if (!ofsUrl || !resourceId || !userId || !password) {
                showStatus('Please enter OFS URL, Resource ID, User ID, and Password', true);
                return;
            }

            const apiUrl = `${ofsUrl}/rest/ofscCore/v1/resources/${resourceId}/inventories?limit=${itemsPerPage}&offset=${offset}`;

            // Create Basic Auth header
            const authString = btoa(`${userId}:${password}`);

            try {
                showStatus('Fetching inventories...');
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Basic ${authString}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                inventoryData = data.items || [];
                totalResults = data.totalResults || 0;
                selectedItems.clear();

                displayInventories(data);
                updatePaginationControls();
                showStatus(`Successfully loaded ${(data.items && data.items.length) || 0} inventories (Total: ${totalResults})`);
            } catch (error) {
                showStatus(`Error fetching inventories: ${error.message}`, true);
                console.error('Error:', error);
            }
        }

        function displayInventories(data) {
            const resultsSection = document.getElementById('resultsSection');
            const tableBody = document.getElementById('inventoryTable');
            const tableHeader = document.getElementById('tableHeader');
            const resultCount = document.getElementById('resultCount');

            resultCount.textContent = `Total Results: ${totalResults}`;

            // Extract all unique column names from the first item
            if ((data.items && data.items.length) || 0 > 0) {
                tableColumns = Object.keys(data.items[0]);

                // Generate dynamic table headers
                tableHeader.innerHTML = `
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                `;

                // Add headers for primary display columns first
                primaryDisplayColumns.forEach(col => {
                    if (tableColumns.includes(col)) {
                        const label = col.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim()
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');

                        const th = document.createElement('th');
                        th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                        th.textContent = label;
                        tableHeader.appendChild(th);
                    }
                });
            }

            tableBody.innerHTML = '';

            data.items && data.items.forEach((item, index) => {
                const mainRow = document.createElement('tr');
                mainRow.className = 'hover:bg-gray-50';

                // Create checkbox cell
                let rowHTML = `
                    <td class="px-4 py-4">
                        <input 
                            type="checkbox" 
                            class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                            onchange="toggleSelection(${item.inventoryId})"
                        />
                    </td>
                    <td class="px-4 py-4">
                        <button 
                            onclick="toggleDetails(${index})" data-id="${JSON.stringify(item).replace(/"/g, "")}"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                        >
                            <span id="toggle-${index}">‚ñº More</span>
                        </button>
                    </td>
                `;

                // Add cells for primary display columns
                primaryDisplayColumns.forEach(col => {
                    if (tableColumns.includes(col)) {
                        let cellValue = item[col] !== null && item[col] !== undefined ? item[col] : 'N/A';

                        // Special formatting for Category
                        if (col === 'Category') {
                            rowHTML += `
                                <td class="px-4 py-4">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${cellValue === 'Good' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        ${cellValue}
                                    </span>
                                </td>
                            `;
                        } else {
                            rowHTML += `<td class="px-4 py-4 text-sm text-gray-900">${cellValue}</td>`;
                        }
                    }
                });

                mainRow.innerHTML = rowHTML;

                // Create details row with all remaining fields
                const detailsRow = document.createElement('tr');
                detailsRow.id = `details-${index}`;
                detailsRow.className = 'hidden bg-gray-50';

                let detailsHTML = '<td colspan="' + (primaryDisplayColumns.length + 2) + '" class="px-4 py-4"><div class="grid grid-cols-2 gap-4 text-sm">';

                // Show all fields in details
                tableColumns.forEach(key => {
                    const label = key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim()
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');

                    const value = item[key] !== null && item[key] !== undefined ? item[key] : 'N/A';
                    detailsHTML += `<div><span class="font-semibold">${label}:</span> ${value}</div>`;
                });

                detailsHTML += '</div></td>';
                detailsRow.innerHTML = detailsHTML;

                tableBody.appendChild(mainRow);
                tableBody.appendChild(detailsRow);
            });

            resultsSection.classList.remove('hidden');
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(totalResults / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalResults);

            // Update page info
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('rangeInfo').textContent = `Showing ${startItem}-${endItem} of ${totalResults}`;

            // Enable/disable buttons
            document.getElementById('firstBtn').disabled = currentPage === 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            document.getElementById('lastBtn').disabled = currentPage >= totalPages;
        }

        function changeLimit() {
            itemsPerPage = parseInt(document.getElementById('limitSelect').value);
            currentPage = 1;
            const offset = (currentPage - 1) * itemsPerPage;
            fetchInventories(offset);
        }

        function firstPage() {
            currentPage = 1;
            const offset = (currentPage - 1) * itemsPerPage;
            fetchInventories(offset);
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                const offset = (currentPage - 1) * itemsPerPage;
                fetchInventories(offset);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalResults / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                const offset = (currentPage - 1) * itemsPerPage;
                fetchInventories(offset);
            }
        }

        function lastPage() {
            const totalPages = Math.ceil(totalResults / itemsPerPage);
            currentPage = totalPages;
            const offset = (currentPage - 1) * itemsPerPage;
            fetchInventories(offset);
        }

        function toggleDetails(index) {
            const detailsRow = document.getElementById(`details-${index}`);
            const toggleBtn = document.getElementById(`toggle-${index}`);

            if (detailsRow.classList.contains('hidden')) {
                detailsRow.classList.remove('hidden');
                toggleBtn.textContent = '‚ñ≤ Less';
            } else {
                detailsRow.classList.add('hidden');
                toggleBtn.textContent = '‚ñº More';
            }
        }

        function toggleSelection(inventoryId) {
            if (selectedItems.has(inventoryId)) {
                selectedItems.delete(inventoryId);
            } else {
                selectedItems.add(inventoryId);
            }
        }

        function selectAll() {
            selectedItems.clear();
            inventoryData.forEach(item => selectedItems.add(item.inventoryId));
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAll() {
            selectedItems.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function downloadBackup() {
            const ofsUrl = document.getElementById('ofsUrl').value.trim();
            const resourceId = document.getElementById('resourceId').value.trim();
            const userId = document.getElementById('ofscUserId').value.trim();
            const password = document.getElementById('ofscPassword').value.trim();

            if (!ofsUrl || !resourceId || !userId || !password) {
                showStatus('Please enter all credentials and fetch inventories first', true);
                return;
            }

            // If we have total results, show confirmation
            if (totalResults > 0) {
                if (!confirm(`This will fetch all ${totalResults} inventory records for backup. This may take some time. Continue?`)) {
                    return;
                }
            } else {
                if (!confirm(`This will fetch all inventory records for this resource. Continue?`)) {
                    return;
                }
            }

            fetchAllInventoriesForBackup();
        }

        async function fetchAllInventoriesForBackup() {
            const ofsUrl = document.getElementById('ofsUrl').value.trim();
            const resourceId = document.getElementById('resourceId').value.trim();
            const userId = document.getElementById('ofscUserId').value.trim();
            const password = document.getElementById('ofscPassword').value.trim();
            const authString = btoa(`${userId}:${password}`);

            allInventoryData = [];
            let offset = 0;
            const limit = 100; // Fetch in larger batches for backup
            let totalCount = 0;

            try {
                showStatus(`Fetching all inventories for backup...`);

                // First call to get total count
                let apiUrl = `${ofsUrl}/rest/ofscCore/v1/resources/${resourceId}/inventories?limit=${limit}&offset=${offset}`;

                let response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Basic ${authString}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                let data = await response.json();
                totalCount = data.totalResults || 0;

                if (totalCount === 0) {
                    showStatus('No inventory data found for this resource', true);
                    return;
                }

                // Add first batch
                allInventoryData = allInventoryData.concat(data.items || []);
                offset += limit;

                showStatus(`Fetching all inventories for backup... ${allInventoryData.length}/${totalCount}`);

                // Continue fetching while we haven't reached totalResults
                while (offset < totalCount) {
                    apiUrl = `${ofsUrl}/rest/ofscCore/v1/resources/${resourceId}/inventories?limit=${limit}&offset=${offset}`;

                    response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `Basic ${authString}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    data = await response.json();
                    const items = data.items || [];

                    // Break if no more items (safety check)
                    if (items.length === 0) {
                        break;
                    }

                    allInventoryData = allInventoryData.concat(items);
                    offset += limit;

                    showStatus(`Fetching all inventories for backup... ${allInventoryData.length}/${totalCount}`);
                }

                // Now create and download the backup
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `inventory_backup_${resourceId}_${timestamp}.json`;

                const backup = {
                    metadata: {
                        resourceId: resourceId,
                        backupDate: new Date().toISOString(),
                        totalItems: allInventoryData.length,
                        ofsUrl: ofsUrl
                    },
                    inventories: allInventoryData
                };

                const jsonString = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonString], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showStatus(`‚úÖ Backup downloaded successfully: ${filename} (${allInventoryData.length} items)`);
            } catch (error) {
                showStatus(`Error creating backup: ${error.message}`, true);
                console.error('Error:', error);
            }
        }

        function updateSelected() {
            if (selectedItems.size === 0) {
                showStatus('Please select at least one item to update', true);
                return;
            }

            if (selectedItems.size > 1) {
                showStatus('Please select only one item to update', true);
                return;
            }

            const selectedId = Array.from(selectedItems)[0];
            const selectedItem = inventoryData.find(item => item.inventoryId === selectedId);

            if (selectedItem) {
                openUpdateModal(selectedItem);
            }
        }



        function openUpdateModal(item) {
            currentEditItem = item;

            // Generate dynamic form fields based on item properties
            const formContainer = document.getElementById('dynamicFormFields');
            formContainer.innerHTML = '';

            // Read-only fields
            const readOnlyFields = ['inventoryId', 'resourceId'];

            Object.keys(item).forEach(key => {
                const fieldDiv = document.createElement('div');

                // Convert camelCase or snake_case to readable label
                const label = key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');

                const isReadOnly = readOnlyFields.includes(key);
                const inputType = typeof item[key] === 'number' ? 'number' : 'text';
                const value = item[key] !== null && item[key] !== undefined ? item[key] : '';

                fieldDiv.innerHTML = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">${label}</label>
                        <input 
                            type="${inputType}" 
                            id="edit_${key}" 
                            data-field="${key}"
                            value="${value}"
                            ${isReadOnly ? 'readonly' : ''}
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg ${isReadOnly ? 'bg-gray-100' : 'focus:ring-2 focus:ring-blue-500'}"
                        />
                    </div>
                `;

                formContainer.appendChild(fieldDiv.firstElementChild);
            });

            document.getElementById('updateModal').classList.remove('hidden');
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').classList.add('hidden');
            currentEditItem = null;
        }

        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const ofsUrl = document.getElementById('ofsUrl').value.trim();
            const resourceId = document.getElementById('resourceId').value.trim();
            const userId = document.getElementById('ofscUserId').value.trim();
            const password = document.getElementById('ofscPassword').value.trim();
            const inventoryId = currentEditItem.inventoryId;

            // Dynamically collect all form field values
            const updatedData = {};
            const formFields = document.querySelectorAll('#dynamicFormFields input[data-field]');

            formFields.forEach(input => {
                const fieldName = input.getAttribute('data-field');
                const fieldValue = input.value;

                // Skip read-only fields
                if (!input.hasAttribute('readonly')) {
                    // Convert to number if input type is number
                    if (input.type === 'number') {
                        updatedData[fieldName] = fieldValue ? parseFloat(fieldValue) : null;
                    } else {
                        updatedData[fieldName] = fieldValue;
                    }
                }
            });

            // Create Basic Auth header
            const authString = btoa(`${userId}:${password}`);

            try {
                const updateUrl = `${ofsUrl}/rest/ofscCore/v1/inventories/${inventoryId}`;
                const response = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Basic ${authString}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });

                if (response.ok) {
                    showStatus('Successfully updated inventory!');
                    closeUpdateModal();
                    fetchInventories();
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                showStatus(`Error updating inventory: ${error.message}`, true);
                console.error('Error:', error);
            }
        });

        async function deleteSelected() {
            if (selectedItems.size === 0) {
                showStatus('Please select at least one item to delete', true);
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedItems.size} item(s)?`)) {
                return;
            }

            const ofsUrl = document.getElementById('ofsUrl').value.trim();
            const resourceId = document.getElementById('resourceId').value.trim();
            const userId = document.getElementById('ofscUserId').value.trim();
            const password = document.getElementById('ofscPassword').value.trim();

            // Create Basic Auth header
            const authString = btoa(`${userId}:${password}`);

            let successCount = 0;
            let errorCount = 0;

            for (const inventoryId of selectedItems) {
                try {
                    const deleteUrl = `${ofsUrl}/rest/ofscCore/v1/inventories/${inventoryId}`;
                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Basic ${authString}`
                        }
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Error deleting inventory ${inventoryId}:`, error);
                }
            }

            showStatus(`Deleted ${successCount} item(s). ${errorCount > 0 ? `Failed: ${errorCount}` : ''}`, errorCount > 0);

            if (successCount > 0) {
                fetchInventories();
            }
        }
        // üîç Filter function
        const searchInput = document.getElementById("searchInput");
        const table = document.getElementById("inventoryTable");

        searchInput.addEventListener("input", function() {
            const filter = this.value.toLowerCase();
            const rows = table.getElementsByTagName("tr");

            for (let row of rows) {
                const text = row.outerHTML.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            }
        });
    </script>
    <script src="./plugin.js"></script>
</body>

</html>